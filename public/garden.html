<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LUMINA - Garden</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #faf9f6; color: #44403c; overflow: hidden; }
        .font-serif { font-family: 'Playfair Display', serif; }
        .fade-in { animation: fadeIn 0.4s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .tree-transition { transition: all 1.2s cubic-bezier(0.4, 0, 0.2, 1); }
        .item-float { animation: float 6s ease-in-out infinite; }
        @keyframes float { 0%, 100% { transform: translate(-50%, -52%) scale(1); } 50% { transform: translate(-50%, -48%) scale(1.05); } }
        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body>
    <div id="root"></div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, deleteDoc, query, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        try {
            const firebaseConfig = JSON.parse(__firebase_config);
            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const db = getFirestore(app);
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'lumina-garden-v1';

            window.FB_MODULES = { auth, db, appId, collection, addDoc, onSnapshot, doc, deleteDoc, query, getDocs, signInAnonymously, signInWithCustomToken, onAuthStateChanged };
        } catch (e) {
            console.error("Firebase config is missing or invalid.");
            window.FB_ERROR = e.message;
        }
    </script>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        const Icons = {
            ChevronLeft: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m15 18-6-6 6-6"/></svg>,
            ChevronRight: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m9 18 6-6-6-6"/></svg>,
            Camera: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/><circle cx="12" cy="13" r="3"/></svg>,
            Home: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>,
            Trash: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>,
            X: () => <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><path d="M18 6 6 18M6 6l12 12"/></svg>,
            Loader: () => <svg className="animate-spin" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3"><circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor"></circle><path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
        };

        const TreeGraphic = ({ entries = [], size = "large" }) => {
            const count = entries.length;
            const scale = count >= 10 ? 1.4 : count >= 5 ? 1.2 : 1.0;
            const w = size === "small" ? 48 : 400;
            const h = size === "small" ? 34 : 260;
            
            return (
                <div className="flex justify-center tree-transition" style={{ transform: `scale(${scale})`, transformOrigin: 'bottom' }}>
                    <svg width={w} height={h} viewBox="0 0 200 120">
                        <path d="M90 120 Q100 115 100 100 T110 120" fill="#8b7e74" />
                        <path d="M5 90 Q5 10 100 5 T195 90 Q195 110 100 115 T5 90" fill={count > 0 ? "#34d399" : "#f1f5f9"} opacity="0.85" />
                        <path d="M100 100 L100 50 M100 85 L40 65 M100 80 L160 60 M100 70 L65 35 M100 65 L135 30" stroke="#fff" strokeWidth="1" opacity="0.4" fill="none" />
                    </svg>
                </div>
            );
        };

        function App() {
            const params = new URLSearchParams(window.location.search);
            const groupId = params.get('groupId') || 'DEMO';

            const [user, setUser] = useState(null);
            const [fbReady, setFbReady] = useState(false);
            const [currentMonth, setCurrentMonth] = useState(new Date());
            const [selectedDate, setSelectedDate] = useState(new Date());
            const [entries, setEntries] = useState([]);
            const [isFormOpen, setIsFormOpen] = useState(false);
            const [isSaving, setIsSaving] = useState(false);
            const [entryIn, setEntryIn] = useState({ message: '', photo: null, color: '#FAF9F6' });
            const [errorMsg, setErrorMsg] = useState(window.FB_ERROR || null);

            // 1. Auth Initialization (RULE 3)
            useEffect(() => {
                const interval = setInterval(async () => {
                    if (window.FB_MODULES) {
                        clearInterval(interval);
                        const { auth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } = window.FB_MODULES;
                        
                        try {
                            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                                await signInWithCustomToken(auth, __initial_auth_token);
                            } else {
                                await signInAnonymously(auth);
                            }
                            setFbReady(true);
                        } catch (err) {
                            console.error("Auth failed:", err);
                            setErrorMsg("認証に失敗しました。再読み込みしてください。");
                        }
                        onAuthStateChanged(auth, setUser);
                    }
                }, 200);
                return () => clearInterval(interval);
            }, []);

            // 2. Data Synchronization
            useEffect(() => {
                if (!user || !fbReady || !window.FB_MODULES) return;
                const { db, appId, collection, onSnapshot } = window.FB_MODULES;
                const colRef = collection(db, 'artifacts', appId, 'public', 'data', 'entries');
                
                const unsubscribe = onSnapshot(colRef, (snap) => {
                    const data = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                    setEntries(data.filter(e => e.groupId === groupId));
                }, (error) => {
                    console.error("Firestore sync error:", error);
                    setErrorMsg("データベースとの通信に失敗しました。");
                });
                return () => unsubscribe();
            }, [user, fbReady, groupId]);

            const calendarDays = useMemo(() => {
                const year = currentMonth.getFullYear();
                const month = currentMonth.getMonth();
                const firstDay = new Date(year, month, 1).getDay();
                const lastDate = new Date(year, month + 1, 0).getDate();
                const days = [];
                for (let i = 0; i < firstDay; i++) days.push(null);
                for (let i = 1; i <= lastDate; i++) days.push(i);
                return days;
            }, [currentMonth]);

            const handleAddEntry = async () => {
                if ((!entryIn.message.trim() && !entryIn.photo) || !fbReady || isSaving || !user) return;
                const { db, appId, collection, addDoc } = window.FB_MODULES;
                
                setIsSaving(true);
                try {
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'entries'), {
                        groupId,
                        diary_date: selectedDate.toISOString().split('T')[0],
                        message: entryIn.message.trim(),
                        image_data: entryIn.photo,
                        color: entryIn.color,
                        created_at: new Date().toISOString()
                    });
                    setEntryIn({ message: '', photo: null, color: '#FAF9F6' });
                    setIsFormOpen(false);
                } catch (e) { 
                    console.error("Save Error:", e);
                    alert(e.message.includes('too large') ? "画像が大きすぎます。" : "保存に失敗しました。");
                } finally {
                    setIsSaving(false);
                }
            };

            const handleDeleteEntry = async (id) => {
                if (!window.confirm("本当にこの記録を削除しますか？")) return;
                const { db, appId, doc, deleteDoc } = window.FB_MODULES;
                try {
                    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'entries', id));
                } catch (e) { alert("削除に失敗しました"); }
            };

            const handleCloseGarden = async () => {
                if (!window.confirm("本当に閉園しますか？\n全ての記録が消去されます。")) return;
                const { db, appId, doc, deleteDoc } = window.FB_MODULES;
                try {
                    for (const entry of entries) {
                        await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'entries', entry.id));
                    }
                    window.location.href = 'index.html';
                } catch (e) { alert("閉園処理に失敗しました"); }
            };

            const currentEntries = useMemo(() => {
                const ds = selectedDate.toISOString().split('T')[0];
                return entries.filter(e => e.diary_date === ds);
            }, [entries, selectedDate]);

            const isButtonDisabled = (!entryIn.message.trim() && !entryIn.photo) || isSaving || !user || !fbReady;

            return (
                <div className="max-w-md mx-auto h-screen bg-white flex flex-col relative overflow-hidden fade-in">
                    <header className="flex justify-between items-center px-6 pt-6 pb-2 shrink-0 z-20">
                        <button onClick={() => window.location.href = 'index.html'} className="p-2 text-stone-400 hover:bg-stone-50 rounded-full transition-colors">
                            <Icons.Home />
                        </button>
                        <div className="text-center">
                            <h1 className="text-sm font-bold text-stone-300 tracking-[0.3em] uppercase">LUMINA</h1>
                            <p className="text-[10px] text-stone-400 font-mono tracking-tighter">ID: {groupId}</p>
                        </div>
                        <button onClick={handleCloseGarden} className="p-2 text-stone-300 hover:text-red-400 hover:bg-red-50 rounded-full transition-colors">
                            <Icons.Trash />
                        </button>
                    </header>

                    <section className="px-6 py-2 shrink-0 z-10">
                        <div className="flex justify-between items-center mb-3">
                            <h2 className="text-2xl font-serif font-bold text-stone-800 tracking-tighter">{currentMonth.getFullYear()}年 {currentMonth.getMonth() + 1}月</h2>
                            <div className="flex gap-2">
                                <button onClick={() => setCurrentMonth(new Date(currentMonth.getFullYear(), currentMonth.getMonth() - 1, 1))} className="p-1 text-stone-300 hover:text-stone-600"><Icons.ChevronLeft /></button>
                                <button onClick={() => setCurrentMonth(new Date(currentMonth.getFullYear(), currentMonth.getMonth() + 1, 1))} className="p-1 text-stone-300 hover:text-stone-600"><Icons.ChevronRight /></button>
                            </div>
                        </div>
                        <div className="bg-white rounded-[2rem] shadow-xl border border-stone-50 p-3">
                            <div className="grid grid-cols-7 gap-1 text-center mb-1">
                                {['日','月','火','水','木','金','土'].map((d, i) => (
                                    <span key={d} className={`text-[9px] font-bold ${i===0 ? 'text-red-300' : i===6 ? 'text-blue-300' : 'text-stone-300'}`}>{d}</span>
                                ))}
                            </div>
                            <div className="grid grid-cols-7 gap-1">
                                {calendarDays.map((day, i) => {
                                    if (!day) return <div key={`empty-${i}`} className="aspect-square" />;
                                    const ds = `${currentMonth.getFullYear()}-${String(currentMonth.getMonth()+1).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
                                    const dayEntries = entries.filter(e => e.diary_date === ds);
                                    const isSelected = selectedDate.getDate() === day && selectedDate.getMonth() === currentMonth.getMonth();
                                    return (
                                        <div key={day} onClick={() => setSelectedDate(new Date(currentMonth.getFullYear(), currentMonth.getMonth(), day))} 
                                             className={`aspect-square relative border border-stone-50 flex flex-col items-center justify-end p-0.5 cursor-pointer transition-all rounded-lg ${isSelected ? 'ring-2 ring-stone-800 bg-stone-50 z-10' : 'hover:bg-stone-50/50'}`}>
                                            <span className={`absolute top-0.5 left-1 text-[7px] font-bold ${isSelected ? 'text-stone-800' : 'text-stone-200'}`}>{day}</span>
                                            <TreeGraphic entries={dayEntries} size="small" />
                                        </div>
                                    );
                                })}
                            </div>
                        </div>
                    </section>

                    <section className="flex-1 px-6 py-4 flex flex-col overflow-hidden relative z-10">
                        <h3 className="text-xl font-serif font-bold text-stone-800 mb-2">
                            {selectedDate.toLocaleDateString('ja-JP', {month:'long', day:'numeric', weekday:'short'})}
                        </h3>
                        <div className="relative w-full flex-1 bg-stone-50/40 rounded-[3rem] overflow-hidden border border-stone-100 flex items-end justify-center p-6 shadow-inner">
                            <div className="absolute bottom-4 w-full flex justify-center scale-[1.6]">
                                <TreeGraphic entries={currentEntries} />
                            </div>
                            
                            <div className="relative z-10 w-full h-full mb-12">
                                {currentEntries.map((item, idx) => (
                                    <div key={item.id} className="absolute item-float group" style={{top: `${15+(idx%5)*15}%`, left: `${15+(idx%4)*22}%`, transform: 'translate(-50%, -50%)'}}>
                                        <div className="p-1 bg-white shadow-xl rounded-2xl border border-stone-100 relative">
                                            {item.image_data ? 
                                                <img src={item.image_data} className="w-16 h-16 object-cover rounded-xl" /> :
                                                <div className="w-16 h-16 flex items-center justify-center bg-stone-50 rounded-xl text-[9px] text-stone-500 text-center leading-tight px-2 font-medium overflow-hidden">
                                                    {item.message}
                                                </div>
                                            }
                                            {item.image_data && item.message && (
                                                <div className="absolute -bottom-2 -left-2 bg-white/90 backdrop-blur-sm px-2 py-1 rounded-md text-[7px] shadow-sm max-w-[80px] truncate border border-stone-50">
                                                    {item.message}
                                                </div>
                                            )}
                                            <button 
                                                onClick={(e) => { e.stopPropagation(); handleDeleteEntry(item.id); }}
                                                className="absolute -top-2 -right-2 bg-red-400 text-white p-1.5 rounded-full shadow-lg opacity-0 group-hover:opacity-100 transition-opacity z-20"
                                            >
                                                <Icons.X />
                                            </button>
                                            <div className="absolute -bottom-1 -right-1 w-3 h-3 rounded-full border-2 border-white shadow-sm" style={{backgroundColor: item.color}} />
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    </section>

                    <div className={`fixed inset-0 z-40 pointer-events-none transition-opacity duration-500 ${isFormOpen ? 'bg-stone-900/10 pointer-events-auto opacity-100' : 'opacity-0'}`} onClick={() => setIsFormOpen(false)} />
                    <div className={`fixed bottom-0 left-0 right-0 max-w-md mx-auto bg-white border-t border-stone-100 rounded-t-[3.5rem] shadow-[0_-20px_50px_rgba(0,0,0,0.1)] z-50 transition-transform duration-500 ease-in-out ${isFormOpen ? 'translate-y-0 h-1/2' : 'translate-y-[calc(100%-64px)] h-auto'}`}>
                        <button onClick={() => setIsFormOpen(!isFormOpen)} className="w-full h-16 flex flex-col items-center justify-center text-stone-200 hover:text-stone-400 transition-colors">
                            <div className="w-12 h-1 bg-stone-100 rounded-full mb-2" />
                            {!isFormOpen && <span className="text-[10px] font-bold tracking-[0.3em] text-stone-300 uppercase font-serif italic">New Memory</span>}
                        </button>
                        <div className="px-8 pb-10 pt-2 space-y-6 overflow-y-auto no-scrollbar h-[calc(100%-64px)]">
                            <div className="flex gap-3 overflow-x-auto no-scrollbar py-2">
                                {['#FAF9F6', '#ff85a2', '#f472b6', '#a78bfa', '#60a5fa', '#34d399', '#fbbf24', '#f87171', '#555555'].map(c => (
                                    <button key={c} onClick={() => setEntryIn({...entryIn, color: c})} className={`w-8 h-8 rounded-full border shrink-0 transition-all ${entryIn.color === c ? 'ring-2 ring-stone-800 scale-110 shadow-md' : 'border-stone-100'}`} style={{backgroundColor: c}} />
                                ))}
                            </div>
                            <div className="flex gap-4 items-start">
                                <div className="flex flex-col items-center gap-2">
                                    <label className="w-16 h-16 shrink-0 flex items-center justify-center bg-stone-50 rounded-[1.5rem] text-stone-300 border shadow-sm cursor-pointer hover:bg-stone-100 transition-colors overflow-hidden relative group">
                                        {entryIn.photo ? (
                                            <img src={entryIn.photo} className="w-full h-full object-cover" />
                                        ) : (
                                            <Icons.Camera />
                                        )}
                                        <input type="file" className="hidden" accept="image/*" onChange={(e) => { 
                                            const r = new FileReader(); 
                                            r.onload = () => setEntryIn({...entryIn, photo: r.result}); 
                                            if(e.target.files[0]) r.readAsDataURL(e.target.files[0]); 
                                        }} />
                                    </label>
                                    {entryIn.photo && (
                                        <button onClick={() => setEntryIn({...entryIn, photo: null})} className="text-[8px] text-red-400 font-bold uppercase tracking-widest">Remove</button>
                                    )}
                                </div>
                                <div className="flex-1 flex flex-col gap-4">
                                    <textarea placeholder="今、この瞬間の想いを..." rows={4} className="w-full bg-stone-50 rounded-[1.5rem] p-4 text-sm outline-none resize-none border border-stone-100 shadow-inner" value={entryIn.message} onChange={e => setEntryIn({...entryIn, message: e.target.value})} />
                                    <button 
                                        onClick={handleAddEntry} 
                                        disabled={isButtonDisabled} 
                                        className={`w-full py-4 rounded-[1.5rem] flex items-center justify-center font-bold shadow-lg active:scale-95 transition-all
                                            ${isButtonDisabled 
                                                ? 'bg-stone-200 text-stone-400 cursor-not-allowed' 
                                                : 'bg-stone-800 text-white hover:bg-stone-900 shadow-stone-200'}`}
                                    >
                                        {!fbReady ? (
                                            <span className="flex items-center gap-2 tracking-widest uppercase text-[10px]">
                                                <Icons.Loader /> {errorMsg ? 'ERROR' : 'CONNECTING...'}
                                            </span>
                                        ) : isSaving ? (
                                            <Icons.Loader />
                                        ) : (
                                            '想い出を庭園に飾る'
                                        )}
                                    </button>
                                    {errorMsg && <p className="text-[8px] text-red-400 text-center uppercase tracking-tighter mt-1">{errorMsg}</p>}
                                </div>
                            </div>
                        </div>
                    </div>

                    <footer className="py-2 text-center text-stone-300 text-[8px] tracking-[0.4em] uppercase z-10 font-bold">
                        &copy; 2024 LUMINA DESIGN STUDIO
                    </footer>
                </div>
            );
        }
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
